<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, user-scalable=no" />
        <title>Liikennematto</title>

        <style>
            #lm-overlay div {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
            }
        </style>
    </head>
    <body>
        <script src="liikennematto.min.js"></script>
        <script>
            var app = Elm.Main.init();

            const AudioContext =
                window.AudioContext || window.webkitAudioContext;
            const context = new AudioContext();
            let active_source = null;
            let sounds = {};

            // Load the game sounds
            getBuffer("build_road_start");
            getBuffer("build_road_end");
            getBuffer("destroy_road");
            getBuffer("build_lot");

            function stopActiveSource() {
                if (active_source) {
                    active_source.onended = null;
                    active_source.stop(0);
                }
            }

            function playSound(soundLabel) {
                const buffer = sounds[soundLabel];
                const source = context.createBufferSource();

                if (!buffer) {
                    return;
                }

                stopActiveSource();
                active_source = source;
                source.onended = function () {
                    active_source = null;
                };

                source.buffer = buffer;
                source.connect(context.destination);
                source.start(0);
            }

            function getBuffer(soundLabel) {
                const request = new XMLHttpRequest();
                const url = "assets/" + soundLabel + ".ogg";

                request.open("GET", url, true);
                request.responseType = "arraybuffer";
                request.onload = function (evt) {
                    context.decodeAudioData(request.response, (buffer) => {
                        sounds[soundLabel] = buffer;
                    });
                };
                request.send();
            }

            app.ports.requestAudio.subscribe(function (sound) {
                if (context.state === "suspended") {
                    context.resume();
                }

                if (active_source) {
                    active_source.stop();
                }

                if (sound) {
                    playSound(sound);
                }
            });
        </script>
    </body>
</html>
