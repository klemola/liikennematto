<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, user-scalable=no" />
        <title>Liikennematto</title>

        <style>
            #lm-overlay div {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
            }
        </style>
    </head>
    <body>
        <script src="liikennematto.min.js"></script>
        <script>
            var app = Elm.Main.init();

            const AudioContext =
                window.AudioContext || window.webkitAudioContext;
            const context = new AudioContext();
            const roadGainNode = context.createGain();
            const roadStereoPannerNode = context.createStereoPanner();
            const lotGainNode = context.createGain();
            const lotStereoPannerNode = context.createStereoPanner();
            let soundSource_road = null;
            let soundSource_lot = null;
            let sounds = {};

            // Load the game sounds
            getBuffer("build_road_start");
            getBuffer("build_road_end");
            getBuffer("destroy_road");
            getBuffer("build_lot");

            roadGainNode.gain.value = 0.4;
            roadStereoPannerNode.pan.value = -0.25;
            lotGainNode.gain.value = 0.2;
            lotStereoPannerNode.pan.value = 0.5;

            roadGainNode
                .connect(roadStereoPannerNode)
                .connect(context.destination);
            lotGainNode
                .connect(lotStereoPannerNode)
                .connect(context.destination);

            app.ports.requestAudio.subscribe(function (sound) {
                if (context.state === "suspended") {
                    context.resume();
                }

                sound && playSound(sound);
            });

            function getBuffer(soundLabel) {
                const request = new XMLHttpRequest();
                const url = "assets/" + soundLabel + ".ogg";

                request.open("GET", url, true);
                request.responseType = "arraybuffer";
                request.onload = function (evt) {
                    context.decodeAudioData(request.response, (buffer) => {
                        sounds[soundLabel] = buffer;
                    });
                };
                request.send();
            }

            function playSound(soundLabel) {
                const buffer = sounds[soundLabel];
                const source = context.createBufferSource();
                const isLotSound = soundLabel === "build_lot";

                if (!buffer) {
                    return;
                }

                stopAudioSource(
                    isLotSound ? soundSource_lot : soundSource_road
                );

                if (isLotSound) {
                    soundSource_lot = source;
                    soundSource_lot.connect(lotGainNode);
                    source.onended = function () {
                        soundSource_lot = null;
                    };
                } else {
                    soundSource_road = source;
                    soundSource_road.connect(roadGainNode);
                    source.onended = function () {
                        soundSource_road = null;
                    };
                }

                source.buffer = buffer;
                source.start(0);
            }

            function stopAudioSource(source) {
                if (source) {
                    source.onended = null;
                    source.stop(0);
                }
            }
        </script>
    </body>
</html>
